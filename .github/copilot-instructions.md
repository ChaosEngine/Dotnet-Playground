# Copilot Instructions
- Repo is a playground solution with main web app in [DotnetPlayground.Web](DotnetPlayground.Web) targeting .NET 10; it pulls in submodules [Caching-MySQL](Caching-MySQL), [InkBall](InkBall), and [IdentityManager2](IdentityManager2) so run `git submodule update --init --recursive` before building.
- Everything is hosted under the `/dotnet` path; `AppRootPath` in [DotnetPlayground.Web/appsettings.json](DotnetPlayground.Web/appsettings.json) and the pipeline in [DotnetPlayground.Web/Startup.cs](DotnetPlayground.Web/Startup.cs) map middleware/endpoints inside `app.Map("/dotnet", ...)`, and session cookies use that path.
- Two DbContexts share the configured database: blogging data and Identity in [DotnetPlayground.Web/Models/BloggingContext.cs](DotnetPlayground.Web/Models/BloggingContext.cs) plus InkBall game data in the referenced module; migrations are applied at startup in DEBUG via [DotnetPlayground.Web/Helpers/ContextFactory.cs](DotnetPlayground.Web/Helpers/ContextFactory.cs) which also seeds Playwright test users.
- Database provider is selected by `DBKind` (`sqlite` default) in config; [DotnetPlayground.Web/Helpers/ContextFactory.cs](DotnetPlayground.Web/Helpers/ContextFactory.cs) wires up SQLite/SQL Server/Postgres/MySQL/Oracle/Mongo (conditional symbols come from build configuration in [DotnetPlayground.Web/DotnetPlayground.Web.csproj](DotnetPlayground.Web/DotnetPlayground.Web.csproj)). Change `DBKind` and connection strings in appsettings or user-secrets.
- Distributed cache backing store is also chosen in `ContextFactory`: SQL Server or MySQL add-ons are registered only when `DBKind` matches; otherwise session falls back to in-memory.
- Identity is configured with ASP.NET Core Identity plus external providers (Google/Facebook/Twitter/GitHub) driven by the `Authentication` section in appsettings; IdentityManager2 admin UI is mounted under `/dotnet/idm` per [DotnetPlayground.Web/Startup.cs](DotnetPlayground.Web/Startup.cs).
- InkBall UI and SignalR endpoints are registered via `AddInkBallCommonUI` and `endpoints.PrepareSignalRForInkBall` in [DotnetPlayground.Web/Startup.cs](DotnetPlayground.Web/Startup.cs); static assets for the game are served from the InkBall moduleâ€™s wwwroot.
- BackgroundTaskQueue is created in Startup to watch `ImageDirectory` for `video.webm` and enqueue YouTube uploads when `YouTubeAPI` secrets exist; leave settings empty to disable silently.
- HTTP pipeline (inside `/dotnet`) enables request decompression, server timing, session, auth, static assets, and a default MVC route plus Razor Pages; non-dev enforces forwarded headers for reverse proxies.
- DataProtection keys persist into the configured database (via `PersistKeysToDbContext`) and can be protected with a cert if `DataProtection:CertFile` is supplied.
- Asset pipeline lives in [gulpfile.mjs](gulpfile.mjs) and uses bun/npm to run gulp: `bun install` (or `pnpm install`/`npm install`) then `bun x gulp` (or `npm run gulp`). `dotnet publish` triggers `bun x gulp --version=$(Version) --env=production` before packaging.
- JS/CSS bundles and translations are generated under [DotnetPlayground.Web/wwwroot](DotnetPlayground.Web/wwwroot) and [InkBall/src/InkBall.Module/wwwroot](InkBall/src/InkBall.Module/wwwroot); clean/minify tasks exist for InkBall workers and styles.
- Build/test workflows: use workspace tasks `build` (`dotnet build`) and `test` (`dotnet test`). Debug build defines all provider symbols; Release defines MySQL only; Oracle configuration exists separately.
- Integration tests in [DotnetPlayground.Tests](DotnetPlayground.Tests) use `WebApplicationFactory` with `AppRootPath` set to `/dotnet/`, default SQLite DB, and skip certain cases when `DOTNET_RUNNING_IN_CONTAINER` is true. `ContextFactory.CreateDBApplyMigrationsAndSeedDebugUsers` migrates and seeds `Playwright1/2` users in DEBUG before the server runs.
- Playwright e2e tests live in [e2e](e2e); config [playwright.config.js](playwright.config.js) starts the app via `dotnet run --project DotnetPlayground.Web/` at `https://localhost:4553/dotnet/`, ignores HTTPS errors, and stores auth state in `e2e/storageStates`. Default users: `Playwright1@test.domain.com` / `Playwright1!` and `Playwright2@test.domain.com` / `Playwright2!` (defined in [e2e/TwoUsersFixtures.js](e2e/TwoUsersFixtures.js)).
- To refresh Playwright auth, delete `e2e/storageStates/*.json` and re-run tests; global setup will sign in users using seeded credentials.
- When adding new endpoints/controllers, remember they execute under `/dotnet`; keep cookie paths and redirects aligned with `AppRootPath` to avoid auth/session issues.
- If adding new DB providers or cache stores, extend `DBKind` handling in `ContextFactory` and adjust build constants in the csproj to include provider packages for the selected configuration.
- For background or asset-related changes, update both the InkBall module and main web wwwroot, then rerun gulp so published outputs stay in sync.
