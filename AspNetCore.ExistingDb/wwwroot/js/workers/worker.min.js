(function (s) {

	function arrayBufferToBinaryString(buffer) {
		var binary = "";
		var bytes = new Uint8Array(buffer);
		var length = bytes.byteLength;
		for (var i = 0; i < length; i++)
			binary += String.fromCharCode(bytes[i]);
		return binary;
	}

	// This is the entry point for our worker
	s.addEventListener('message', function (e) {
		var data = JSON.parse(arrayBufferToBinaryString(e.data));

		// In web workers we can use importScripts to load external javascripts
		for (var i = 0; i < data.libsToLoad.length; ++i)
			importScripts(data.libsToLoad[i]);

		// Save a timestamp when we started
		var lastUpdateMilis = new Date().getTime(),
			currentMilis = new Date().getTime(),
			pass, hexHash;

		var products = new LazyProduct(data.passCharacterLength, data.alphabet);

		// Perform the loop on the range and start generating hashes :-)
		for (var i = data.range.low; i < data.range.high; i++) {
			// Hash our number password with a salt and key stretching
			pass = products.item(i);
			hexHash = hash(pass);

			// Get current time for resporting the status
			currentMilis = new Date().getTime();

			// If last status update is older than updateRate in ms or fallback to 25ms
			if ((currentMilis - lastUpdateMilis) > (data.updateRate || 25)) {
				// Update status to host
				var cmd = {
					update: {
						hash: hexHash,
						passphrase: pass,
						remaining: data.range.high - i
					}
				};
				var buff = binaryStringToArrayBuffer(JSON.stringify(cmd));
				s.postMessage(buff, [buff]);
				// Update lastUpdateTime
				lastUpdateMilis = currentMilis;
			}

			// We found the hash!!!! :-)
			if (hexHash === data.hash) {
				var cmd = {
					found: {
						hash: hexHash,
						passphrase: pass,
						remaining: data.range.high - i,
						//timeSpent: new Date().getTime() - startTime.getTime()
					}
				};
				var buff = binaryStringToArrayBuffer(JSON.stringify(cmd));
				s.postMessage(buff, [buff]);
				break;
			}
		}

		var cmd = {
			done: {
				//timeSpent: new Date().getTime() - startTime.getTime(),
				hash: hexHash
			}
		};
		var buff = binaryStringToArrayBuffer(JSON.stringify(cmd));
		s.postMessage(buff, [buff]);
	});

}(self));
